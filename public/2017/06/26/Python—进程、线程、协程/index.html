<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Python—进程、线程、协程 | i@m</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><script type="text/javascript" src="/js/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Python—进程、线程、协程</h1><a id="logo" href="/.">i@m</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Python—进程、线程、协程</h1><div class="post-meta">Jun 26, 2017<span> | </span><span class="category"><a href="/categories/Python/">Python</a></span><script src="/js/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p><strong>一、线程</strong></p>
<p>　　线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务</p>
<p>方法：</p>
<p>　　start            线程准备就绪，等待CPU调度</p>
<p>　　setName      设置线程名称</p>
<p>　　getName      获取线程名称</p>
<p>　　setDaemon   把一个主进程设置为Daemon线程后，主线程执行过程中，后台线程也在进行，主线程执行完毕后，后台线程不论有没执行完成，都会停止</p>
<p>　　join              逐个执行每个线程，执行完毕后继续往下执行，该方法使得多线程变得无意义　　</p>
<p>　　run              线程被cpu调度后自动执行线程对象的run方法</p>
<p><strong>threading模块</strong></p>
<p>　　线程的两种调用方式：</p>
<p>1.直接调用（常用）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">import threading</div><div class="line">import time</div><div class="line"></div><div class="line">&apos;&apos;&apos;直接调用&apos;&apos;&apos;</div><div class="line"></div><div class="line">def hello(name):</div><div class="line">    print(&quot;Hello %s&quot;%name)</div><div class="line">    time.sleep(3)</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    t1=threading.Thread(target=hello,args=(&quot;zhangsan&quot;,)) #生成线程实例</div><div class="line">    t2=threading.Thread(target=hello,args=(&quot;lisi&quot;,))</div><div class="line"></div><div class="line">    t1.setName(&quot;aaa&quot;)   #设置线程名</div><div class="line">    t1.start()  #启动线程</div><div class="line">    t2.start()</div><div class="line">    t2.join()   #join  等待t2先执行完</div><div class="line">    print(&quot;Hello&quot;)</div><div class="line">    print(t1.getName()) #获取线程名</div></pre></td></tr></table></figure>
<p>2.继承式调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&apos;&apos;&apos;继承式调用&apos;&apos;&apos;</div><div class="line">import threading</div><div class="line">import time</div><div class="line">class MyThread(threading.Thread):</div><div class="line">    def __init__(self,name):</div><div class="line">        threading.Thread.__init__(self)</div><div class="line">        self.name = name</div><div class="line">    def run(self):</div><div class="line">        print(&quot;Hello %s&quot;%self.name)</div><div class="line">        time.sleep(3)</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    t1=MyThread(&quot;zhangsan&quot;)</div><div class="line">    t2=MyThread(&quot;lisi&quot;)</div><div class="line">    t1.start()</div><div class="line">    t2.start()</div></pre></td></tr></table></figure>
<p><strong>setDaemon线程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">import time</div><div class="line">import threading</div><div class="line">def run(n):</div><div class="line">    print(&apos;Hello..[%s]\n&apos; % n)</div><div class="line">    time.sleep(2)</div><div class="line"></div><div class="line">def main():</div><div class="line">    for i in range(5):</div><div class="line">        t = threading.Thread(target=run,args=[i,])</div><div class="line">        t.start()</div><div class="line">        t.join(1)</div><div class="line"></div><div class="line">m = threading.Thread(target=main,args=[])</div><div class="line">m.setDaemon(True) #将主线程设置Daemon设置为True后,主线程执行完成时,其它子线程会同时退出,不管是否执行完任务</div><div class="line">m.start()</div><div class="line">print(&quot;--- done----&quot;)</div></pre></td></tr></table></figure>
<p><strong>线程锁Lock</strong></p>
<p>　　一个进程下可以启动多个线程，多个线程共享父进程的内存空间，每个线程可以访问同一份数据，所以当多个线程同时要修改同一份数据时，就会出现错误</p>
<p>　　例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">import threading</div><div class="line">import time</div><div class="line"></div><div class="line">num = 100 #设置一个共享变量</div><div class="line">def show():</div><div class="line">    global num  #在函数内操作函数外变量，需设置为全局变量</div><div class="line">    time.sleep(1)</div><div class="line">    num -= 1</div><div class="line">list=[]</div><div class="line">for i in range(100):</div><div class="line">    t = threading.Thread(target=show)</div><div class="line">    t.start()</div><div class="line">    list.append(t)</div><div class="line"></div><div class="line">for t in list:</div><div class="line">    t.join()</div><div class="line">print(num)</div></pre></td></tr></table></figure>
<p>　上面的例子在正常执行完成后的num的结果应该是0，但实际上每次的执行结果都不太一样，因为当多个线程同时要修改同一份数据时，就会出现一些错误（只有</p>
<p>在python2.x运行才会出现错误，python3.x中不会），所以每个线程在要修改公共数据时，为了避免自己在还没改完的时候别人也来修改此数据，可以加上线程锁</p>
<p>来确保每次修改数据时只有一个线程在操作。</p>
<p>　　加锁代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">import threading</div><div class="line">import time</div><div class="line"></div><div class="line">num = 100 #设置一个共享变量</div><div class="line">lock=threading.Lock()  #生成全局锁</div><div class="line">def show():</div><div class="line">    global num  #在函数内操作函数外变量，需设置为全局变量</div><div class="line">    time.sleep(1)</div><div class="line">    lock.acquire()  #修改前加锁</div><div class="line">    num -= 1</div><div class="line">    lock.release()  #修改后解锁</div><div class="line">list=[]</div><div class="line">for i in range(100):</div><div class="line">    t = threading.Thread(target=show)</div><div class="line">    t.start()</div><div class="line">    list.append(t)</div><div class="line"></div><div class="line">for t in list:</div><div class="line">    t.join()</div><div class="line"></div><div class="line">print(num)</div></pre></td></tr></table></figure>
<p><strong>递归锁RLock</strong></p>
<p>　　就是在一个大锁中再包含子锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">import threading</div><div class="line">#递归锁</div><div class="line">def run1():</div><div class="line">    lock.acquire()  #小锁</div><div class="line">    global num</div><div class="line">    num +=1</div><div class="line">    lock.release()</div><div class="line">    return num</div><div class="line">def run2():</div><div class="line">    lock.acquire()  #小锁</div><div class="line">    global  num2</div><div class="line">    num2+=1</div><div class="line">    lock.release()</div><div class="line">    return num2</div><div class="line">def run3():</div><div class="line">    lock.acquire()  #大锁</div><div class="line">    res = run1()</div><div class="line">    res2 = run2()</div><div class="line">    lock.release()</div><div class="line">    print(res,res2)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    num,num2 = 0,0</div><div class="line">    lock = threading.RLock()    #生成Rlock</div><div class="line">    for i in range(10):</div><div class="line">        t = threading.Thread(target=run3)</div><div class="line">        t.start()</div><div class="line"></div><div class="line">while threading.active_count() != 1:#如果不等于1，说明子线程还没执行完毕</div><div class="line">    pass #打印进程数</div><div class="line">else:</div><div class="line">    print(num,num2)</div></pre></td></tr></table></figure>
<p><strong>Semaphore</strong></p>
<p><strong>　　</strong>同时允许一定数量的线程更改数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">import threading</div><div class="line">import time</div><div class="line">def run(n):</div><div class="line">    semaphore.acquire()</div><div class="line">    time.sleep(1)</div><div class="line">    print(&quot;run the thread: %s&quot; %n)</div><div class="line">    semaphore.release()</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    semaphore  = threading.BoundedSemaphore(3) #设置最多允许3个线程同时运行</div><div class="line">    for i in range(20):</div><div class="line">        t = threading.Thread(target=run,args=(i,))</div><div class="line">        t.start()</div><div class="line">while threading.active_count() != 1:</div><div class="line">    pass</div><div class="line">else:</div><div class="line">    print(&apos;----done---&apos;)</div></pre></td></tr></table></figure>
<p><strong>event</strong></p>
<p>　　实现两个或多个线程间的交互，提供了三个方法 set、wait、clear，默认碰到event.wait 方法时就会阻塞。</p>
<p>　　event.set()，设定后遇到wait不阻塞</p>
<p>　　event.clear()，设定后遇到wait后阻塞</p>
<p>　　event.isSet()，判断有没有被设定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">import threading</div><div class="line">def start():</div><div class="line">    print(&quot;---start---1&quot;)</div><div class="line">    event.wait()    #阻塞</div><div class="line">    print(&quot;---start---2&quot;)</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    event = threading.Event()</div><div class="line">    t = threading.Thread(target=start)</div><div class="line">    t.start()</div><div class="line"></div><div class="line">    result=input(&quot;&gt;&gt;:&quot;)</div><div class="line">    if result == &quot;set&quot;:</div><div class="line">        event.set() #设定set，wait不阻塞</div></pre></td></tr></table></figure>
<p><strong>二、进程</strong></p>
<p>multiprocessing模块</p>
<p>进程调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">from multiprocessing import Process</div><div class="line">import time</div><div class="line">def start(name):</div><div class="line">    time.sleep(1)</div><div class="line">    print(&apos;hello&apos;, name)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    p = Process(target=start, args=(&apos;zhangsan&apos;,))</div><div class="line">    p1 = Process(target=start, args=(&apos;lisi&apos;,))</div><div class="line">    p.start()</div><div class="line">    p1.start()</div><div class="line">    p.join()</div></pre></td></tr></table></figure>
<p>进程间通讯</p>
<p>　　每个进程都拥有自己的内存空间，因此不同进程间内存是不共享的，要想实现两个进程间的数据交换，有几种方法</p>
<p>Queue（队列）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">from multiprocessing import Process, Queue</div><div class="line">def start(q):</div><div class="line">    q.put( &apos;hello&apos;)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    q = Queue()</div><div class="line">    p = Process(target=start, args=(q,))</div><div class="line">    p.start()</div><div class="line">    print(q.get())</div><div class="line">    p.join()</div></pre></td></tr></table></figure>
<p>Pipe（管道，不常用）</p>
<p>　　把管道的两头分别赋给两个进程，实现两个进程的互相通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">from multiprocessing import Process, Pipe</div><div class="line"></div><div class="line">def start(conn):</div><div class="line">    conn.send(&apos;hello&apos;)#发送</div><div class="line">    print(conn.recv())#接收</div><div class="line">    conn.close()</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    parent_conn, child_conn = Pipe()    #生成一个管道</div><div class="line">    p = Process(target=start, args=(child_conn,))</div><div class="line">    p.start()</div><div class="line">    print(parent_conn.recv())#接收</div><div class="line">    parent_conn.send(&quot;11111&quot;)#发送</div><div class="line">    p.join()</div></pre></td></tr></table></figure>
<p>Manager（实现了进程间真正的数据共享）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line">from multiprocessing import Process, Manager</div><div class="line">def f(dic, list,i):</div><div class="line">    dic[&apos;1&apos;] = 1</div><div class="line">    dic[&apos;2&apos;] = 2</div><div class="line">    dic[&apos;3&apos;] = 3</div><div class="line">    list.append(i)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    manager = Manager()</div><div class="line">    dic = manager.dict()#通过manager生成一个字典</div><div class="line">    list = manager.list(range(5))#通过manager生成一个列表</div><div class="line">    p_list = []</div><div class="line">    for i in range(10):</div><div class="line">        p = Process(target=f, args=(dic, list,i))</div><div class="line">        p.start()</div><div class="line">        p_list.append(p)</div><div class="line">    for res in p_list:</div><div class="line">        res.join()</div><div class="line"></div><div class="line">    print(dic)</div><div class="line">    print(list)</div><div class="line">#执行结果</div><div class="line">&apos;&apos;&apos;</div><div class="line">&#123;&apos;2&apos;: 2, &apos;3&apos;: 3, &apos;1&apos;: 1&#125;</div><div class="line">[0, 1, 2, 3, 4, 1, 9, 2, 5, 3, 7, 6, 0, 8, 4]</div><div class="line">&apos;&apos;&apos;</div></pre></td></tr></table></figure>
<p>进程池</p>
<p>　　进程池内部维护一个进程序列，当使用时，则去进程池中获取一个进程，如果进程池序列中没有可供使用的进程，那么程序就会等待，直到进程池中有可用进程为止。</p>
<p>进程池中有两个方法：</p>
<p>1、apply（同步）</p>
<p>2、apply_async（异步）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">from  multiprocessing import Process,Pool</div><div class="line">import time</div><div class="line"></div><div class="line">def Foo(i):</div><div class="line">    time.sleep(1)</div><div class="line">    return i+100</div><div class="line"></div><div class="line">def Bar(arg):</div><div class="line">    print(&apos;number::&apos;,arg)</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    pool = Pool(3)#定义一个进程池，里面有3个进程</div><div class="line">    for i in range(10):</div><div class="line">        pool.apply_async(func=Foo, args=(i,),callback=Bar)</div><div class="line">        #pool.apply(func=Foo, args=(i,))</div><div class="line"></div><div class="line">    pool.close()#关闭进程池</div><div class="line">    pool.join()#进程池中进程执行完毕后再关闭,(必须先close在join)</div></pre></td></tr></table></figure>
<p>callback是回调函数，就是在执行完Foo方法后会自动执行Bar函数，并且自动把Foo函数的返回值作为参数传入Bar函数</p>
<p><strong>三、协程</strong></p>
<p>　　协程，又称微线程，是一种用户态的轻量级线程。协程能保留上一次调用时的状态，每次过程重入时，就相当于进入上一次调用的状态，换种说法：进入上一次离开时所处逻辑流的位置，当程序中存在大量不需要CPU的操作时（IO），适用于协程。</p>
<p>协程有极高的执行效率，因为子程序切换不是线程切换，而是由程序自身控制，因此，没有线程切换的开销。</p>
<p>不需要多线程的锁机制，因为只有一个线程，也不存在同时写变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</p>
<p>因为协程是一个线程执行，所以想要利用多核CPU，最简单的方法是多进程+协程，这样既充分利用多核，又充分发挥协程的高效率。</p>
<p>那符合什么条件就能称之为协程：1、必须在只有一个单线程里实现并发 2、修改共享数据不需加锁 3、用户程序里自己保存多个控制流的上下文栈 4、一个协程遇到IO操作自动切换到其它协程</p>
<p>python中对于协程有两个模块，greenlet和gevent。</p>
<p>Greenlet（greenlet的执行顺序需要我们手动控制）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding:utf-8 -*-</div><div class="line">from greenlet import greenlet</div><div class="line">def test1():</div><div class="line">    print (11)</div><div class="line">    gr2.switch()    #手动切换</div><div class="line">    print (22)</div><div class="line">    gr2.switch()</div><div class="line"></div><div class="line">def test2():</div><div class="line">    print (33)</div><div class="line">    gr1.switch()</div><div class="line">    print (44)</div><div class="line"></div><div class="line">gr1 = greenlet(test1)</div><div class="line">gr2 = greenlet(test2)</div><div class="line">gr1.switch()</div></pre></td></tr></table></figure>
<p>gevent（自动切换，由于切换是在IO操作时自动完成，所以gevent需要修改Python自带的一些标准库，这一过程在启动时通过monkey patch完成）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">from gevent import monkey; monkey.patch_all()</div><div class="line">import gevent</div><div class="line">import time</div><div class="line"></div><div class="line"></div><div class="line">def foo():</div><div class="line">    print(&apos;11&apos;)</div><div class="line">    time.sleep(3)</div><div class="line">    print(&apos;22&apos;)</div><div class="line"></div><div class="line">def bar():</div><div class="line">    print(&apos;33&apos;)</div><div class="line">    print(&apos;44&apos;)</div><div class="line"></div><div class="line">gevent.joinall([</div><div class="line">    gevent.spawn(foo),</div><div class="line">    gevent.spawn(bar),</div><div class="line">])</div></pre></td></tr></table></figure>
<p>运行结果：（从结果可以看出，它们是并发执行的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">11</div><div class="line">33</div><div class="line">44</div><div class="line">22</div></pre></td></tr></table></figure>
<p>参考：</p>
<p><a href="http://www.cnblogs.com/wupeiqi/articles/5040827.html" target="_blank" rel="external">http://www.cnblogs.com/wupeiqi/articles/5040827.html</a></p>
<p><a href="http://www.cnblogs.com/alex3714/articles/5230609.html" target="_blank" rel="external">http://www.cnblogs.com/alex3714/articles/5230609.html</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mpengju.com/2017/06/26/Python—进程、线程、协程/" data-id="cj4dgq6ts001obcvsqfnhwi7e" class="article-share-link">分享</a><div class="tags"><a href="/tags/Python/">Python</a></div><div class="post-nav"><a href="/2017/06/26/Python入门之生成海贼王云图/" class="pre">Python入门之生成海贼王云图</a><a href="/2017/06/26/Python基础/" class="next">Python基础</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mpengju.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/fedora/">fedora</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/html/">html</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nodejs/">nodejs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/raspberry-pi/">raspberry pi</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/react/">react</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/树莓派/">树莓派</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/正则/">正则</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/移动端/">移动端</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/tags/webview/" style="font-size: 15px;">webview</a> <a href="/tags/h5/" style="font-size: 15px;">h5</a> <a href="/tags/Django/" style="font-size: 15px;">Django</a> <a href="/tags/fedora/" style="font-size: 15px;">fedora</a> <a href="/tags/SSH/" style="font-size: 15px;">SSH</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/html/" style="font-size: 15px;">html</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/代码块/" style="font-size: 15px;">代码块</a> <a href="/tags/SASS/" style="font-size: 15px;">SASS</a> <a href="/tags/树莓派/" style="font-size: 15px;">树莓派</a> <a href="/tags/物联网/" style="font-size: 15px;">物联网</a> <a href="/tags/远程登录/" style="font-size: 15px;">远程登录</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/ajax/" style="font-size: 15px;">ajax</a> <a href="/tags/上传/" style="font-size: 15px;">上传</a> <a href="/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/tags/vlc/" style="font-size: 15px;">vlc</a> <a href="/tags/清理垃圾/" style="font-size: 15px;">清理垃圾</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/域名/" style="font-size: 15px;">域名</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/命令/" style="font-size: 15px;">命令</a> <a href="/tags/转换/" style="font-size: 15px;">转换</a> <a href="/tags/存储/" style="font-size: 15px;">存储</a> <a href="/tags/jquery/" style="font-size: 15px;">jquery</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/less/" style="font-size: 15px;">less</a> <a href="/tags/格式化/" style="font-size: 15px;">格式化</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/卸载/" style="font-size: 15px;">卸载</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/邮件/" style="font-size: 15px;">邮件</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/主题/" style="font-size: 15px;">主题</a> <a href="/tags/移动端/" style="font-size: 15px;">移动端</a> <a href="/tags/WEB/" style="font-size: 15px;">WEB</a> <a href="/tags/兼容性/" style="font-size: 15px;">兼容性</a> <a href="/tags/正则/" style="font-size: 15px;">正则</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/最安全的api接口认证/">最安全的api接口认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/长按删除/">长按删除</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/在树莓派上搭建代码托管服务(SVN)/">树莓派搭建SVN</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/在树莓派上安装配置samba/">树莓派安装samba</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/在树莓派3B上安装node.js/">在树莓派3B上安装nodejs</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/有关ie浏览器怪异模式QuirksMode对HTML页面的影响的解决办法/">有关ie浏览器怪异模式QuirksMode对HTML页面的影响的解决办法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/用树莓派B+连接HC-sr04超声模块测距/">用树莓派B+连接HC-sr04超声模块测距</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/用JSJQUERY获取地址栏参数的方法/">用JS\JQUERY获取地址栏参数的方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/移动web资源整理/">移动web资源整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/26/移动web页面给用户发送邮件的方法/">移动端WEB给用户发送邮件</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://mpengju.com" title="i@m" target="_blank">i@m</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">i@m.</a> Powered by<a rel="nofollow" target="_blank"> Hexo.</a><a rel="nofollow" target="_blank"> Theme</a> by<a rel="nofollow" target="_blank" href="mailto:i@mpengju.com?subject=我是？&amp;body=很高兴认识你"> i@mpengju.com</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>